<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Super League Grid</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f0f5f1; --surface: #ffffff; --surface-hover: #e8f0e9; --border: #c2d4c4;
    --accent: #5da261; --correct: #3a8a3f; --wrong: #c0392b; --text: #1a2e1c;
    --text-dim: #5a7a5d;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; padding-bottom: 50px; }
  .header { text-align: center; padding: 20px; }
  .header h1 { font-family: 'Bebas Neue', sans-serif; font-size: 3rem; color: var(--text); }
  .stats-bar { display: flex; justify-content: center; gap: 20px; padding: 10px; font-weight: bold; }
  .grid-wrapper { display: flex; justify-content: center; padding: 10px; }
  .grid-container { display: grid; grid-template-columns: 100px repeat(3, 1fr); gap: 4px; max-width: 500px; width: 100%; }
  .header-cell { background: var(--surface); border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px; text-align: center; min-height: 80px; font-family: 'Bebas Neue'; }
  .team-logo { width: 40px; height: 40px; object-fit: contain; margin-bottom: 4px; }
  .cell { background: var(--surface); border: 1px solid var(--border); min-height: 85px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; padding: 5px; text-align: center; }
  .cell.filled { background: #f0fff1; border-color: var(--correct); }
  .player-name { font-weight: bold; font-size: 0.75rem; color: var(--correct); }
  .player-rarity { font-size: 0.65rem; color: var(--text-dim); }
  .cell.wrong { background: #fff0f0; border-color: var(--wrong); }
  /* Suche */
  .search-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 1000; align-items: center; justify-content: center; }
  .search-overlay.active { display: flex; }
  .search-box { background: white; border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 400px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
  .search-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; }
  .search-result { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
  .search-result:hover { background: var(--bg); }
  .cat-tag { font-size: 0.6rem; padding: 2px 5px; background: #eee; border-radius: 4px; margin-bottom: 3px; text-transform: uppercase; }
</style>
</head>
<body>
  <header class="header">
    <h1>SUPER LEAGUE GRID</h1>
    <p>Das tägliche Schweizer Fussball-Quiz</p>
  </header>
  <div class="stats-bar">
    Punkte: <span id="score">0</span> | Versuche: <span id="tries">9/9</span>
  </div>
  <div class="grid-wrapper">
    <div class="grid-container" id="grid"></div>
  </div>

  <div class="search-overlay" id="searchOverlay">
    <div class="search-box">
      <h3 id="searchHint" style="margin-bottom:10px"></h3>
      <input class="search-input" id="searchInput" type="text" placeholder="Spieler suchen...">
      <div id="searchResults" style="max-height:200px; overflow-y:auto"></div>
      <button onclick="closeSearch()" style="margin-top:10px; width:100%; padding:8px; background:#eee; border:none; border-radius:8px; cursor:pointer">Abbrechen</button>
    </div>
  </div>

<script>
const TEAM_DATA = {
  "Basel": { file: "FC Basel 1893", label: "Basel" },
  "Young Boys": { file: "BSC Young Boys", label: "YB" },
  "Zürich": { file: "FC Zurich", label: "Zürich" },
  "St. Gallen": { file: "FC St. Gallen 1879", label: "St. Gallen" },
  "Luzern": { file: "FC Luzern", label: "Luzern" },
  "Servette": { file: "Servette FC", label: "Servette" },
  "Sion": { file: "FC Sion", label: "Sion" },
  "Grasshopper": { file: "Grasshopper Club Zurich", label: "GC" },
  "Lugano": { file: "FC Lugano", label: "Lugano" },
  "Winterthur": { file: "FC Winterthur", label: "Winterthur" },
  "Lausanne": { file: "FC Lausanne-Sport", label: "Lausanne" },
  "Aarau": { file: "FC Aarau", label: "Aarau" },
  "Thun": { file: "FC Thun", label: "Thun" },
  "England": { file: "Premier League", label: "England" },
  "Germany": { file: "Bundesliga", label: "Deutschland" },
  "Italy": { file: "Serie A", label: "Italien" },
  "France": { file: "Ligue 1", label: "Frankreich" },
  "Spain": { file: "La Liga", label: "Spanien" }
};

let state = { rows: [], cols: [], score: 0, tries: 9, cells: {}, usedPlayers: new Set(), selectedCell: null };

function headerHTML(cat) {
  if (cat.type === 'team' || cat.type === 'league') {
    const data = TEAM_DATA[cat.value];
    const fileName = data ? data.file : cat.value;
    return `<img class="team-logo" src="/logos/${fileName}.png" onerror="this.src='https://placehold.co/40x40?text=⚽'"><span>${cat.label}</span>`;
  }
  const labels = { 'nation': 'Land', 'goals_50': 'Tore', 'assists_10': 'Assists', 'assists_50': 'Assists', 'champion': 'Titel' };
  return `<span class="cat-tag">${labels[cat.type] || 'Info'}</span><span style="font-size:0.8rem">${cat.label}</span>`;
}

function renderGrid() {
  const container = document.getElementById('grid');
  container.innerHTML = '<div class="header-cell">⚽</div>';
  state.cols.forEach(c => {
    const div = document.createElement('div');
    div.className = 'header-cell';
    div.innerHTML = headerHTML(c);
    container.appendChild(div);
  });

  for (let r = 0; r < 3; r++) {
    const rowH = document.createElement('div');
    rowH.className = 'header-cell';
    rowH.innerHTML = headerHTML(state.rows[r]);
    container.appendChild(rowH);

    for (let c = 0; c < 3; c++) {
      const key = `${r}-${c}`;
      const div = document.createElement('div');
      div.className = 'cell';
      if (state.cells[key]) {
        div.classList.add('filled');
        div.innerHTML = `<div><div class="player-name">${state.cells[key].name}</div><div class="player-rarity">${state.cells[key].rarity} Pkt</div></div>`;
      } else if (state.cells[key] === false) {
        div.classList.add('wrong');
        div.innerHTML = '✕';
      } else {
        div.onclick = () => openSearch(key);
      }
      container.appendChild(div);
    }
  }
}

async function initGame() {
  const res = await fetch('/api/daily-grid');
  const data = await res.json();
  state.rows = data.rows;
  state.cols = data.cols;
  renderGrid();
}

function openSearch(key) {
  state.selectedCell = key;
  document.getElementById('searchOverlay').classList.add('active');
  document.getElementById('searchInput').focus();
}

function closeSearch() {
  document.getElementById('searchOverlay').classList.remove('active');
}

document.getElementById('searchInput').oninput = async (e) => {
  if (e.target.value.length < 2) return;
  const res = await fetch(`/api/search?q=${e.target.value}`);
  const players = await res.json();
  const results = document.getElementById('searchResults');
  results.innerHTML = '';
  players.forEach(p => {
    const d = document.createElement('div');
    d.className = 'search-result';
    d.textContent = p.n;
    d.onclick = () => makeGuess(p.n);
    results.appendChild(d);
  });
};

async function makeGuess(name) {
  if (state.usedPlayers.has(name)) return alert("Schon benutzt!");
  const key = state.selectedCell;
  const [r, c] = key.split('-').map(Number);
  closeSearch();

  const res = await fetch('/api/verify', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ playerName: name, rowCat: state.rows[r], colCat: state.cols[c] })
  });
  const result = await res.json();

  if (result.correct) {
    state.cells[key] = { name, rarity: result.rarity };
    state.score += parseFloat(result.rarity);
    state.usedPlayers.add(name);
  } else {
    state.cells[key] = false;
  }
  state.tries--;
  document.getElementById('score').textContent = state.score.toFixed(1);
  document.getElementById('tries').textContent = `${state.tries}/9`;
  renderGrid();
  if (state.tries === 0) alert("Spiel beendet! Punkte: " + state.score.toFixed(1));
}

initGame();
</script>
</body>
</html>